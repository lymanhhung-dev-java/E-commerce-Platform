<div class="container my-5" *ngIf="product">

  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb small text-muted">
      <li class="breadcrumb-item"><a routerLink="/" class="text-decoration-none text-muted">Trang chủ</a></li>
      <li class="breadcrumb-item"><a href="#" class="text-decoration-none text-muted">Đồ điện tử</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ product.categoryName || 'Sản phẩm' }}</li>
    </ol>
  </nav>

  <div class="row gx-5">

    <div class="col-md-6 mb-4">
      <div
        class="position-relative mb-3 image-container bg-light rounded-4 overflow-hidden d-flex justify-content-center align-items-center">
        <span class="badge bg-warning text-dark position-absolute top-0 start-0 m-3 px-3 py-2 fw-bold"
          style="z-index: 10;">BÁN CHẠY NHẤT</span>

        <img [src]="mainImage" class="main-image cursor-pointer" [alt]="product.name" (click)="openZoom()">

      </div>

      <div class="d-flex gap-2 overflow-auto">
        <div *ngFor="let thumb of thumbnails" class="thumb-box rounded-3 border cursor-pointer"
          [class.active-thumb]="mainImage === thumb" (click)="changeImage(thumb)">
          <img [src]="thumb" class="img-fluid rounded-3">
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <h2 class="fw-bold mb-2 text-dark">{{ product.name }}</h2>

      <div class="d-flex align-items-center mb-3 text-warning small">
        <app-star-rating [rating]="averageRating" [readonly]="true" [size]="16"></app-star-rating>
        <span class="text-muted text-decoration-underline ms-2 text-dark">({{ totalReviews }} đánh giá)</span>
        <span class="text-success ms-3 fw-bold small"><i class="bi bi-check-circle-fill"></i> Xác nhận đã mua
          hàng</span>
      </div>

      <div class="mb-4">
        <span class="fs-1 fw-bold text-danger me-3">{{ product.price | currency:'VND':'symbol':'1.0-0' }}</span>
        <span class="text-decoration-line-through text-muted fs-5 me-2">{{ product.price * 1.2 |
          currency:'VND':'symbol':'1.0-0' }}</span>
        <span class="badge bg-danger-subtle text-danger">Giảm giá 20%</span>
      </div>

      <div class="d-flex align-items-center bg-light p-3 rounded-3 mb-4">
        <div class="bg-dark text-white rounded-circle d-flex justify-content-center align-items-center me-3"
          style="width: 40px; height: 40px;">
          <i class="bi bi-shop"></i>
        </div>
        <div class="flex-grow-1">
          <div class="small text-muted">Bán bởi</div>
          <div class="fw-bold text-primary cursor-pointer" [routerLink]="['/shop', product.shopId]">
            {{ product.shopName || 'Shop Chính Chủ' }} <i class="bi bi-box-arrow-up-right small"></i>
          </div>
        </div>
        <button class="btn btn-outline-secondary btn-sm"><i class="bi bi-chat-dots"></i> Nhắn tin</button>
      </div>

      <div class="mb-4">
        <span class="badge bg-success-subtle text-success px-3 py-2 rounded-pill">
          <i class="bi bi-dot"></i>
          Kho: còn {{ product.stockQuantity }} sản phẩm
        </span>
      </div>

      <div class="d-flex flex-wrap gap-3 mb-4">
        <div class="input-group" style="width: 130px;">
          <button class="btn btn-outline-secondary" type="button" (click)="decreaseQty()">-</button>
          <input type="text" class="form-control text-center border-secondary" [value]="quantity" readonly>
          <button class="btn btn-outline-secondary" type="button" (click)="increaseQty()">
            +
          </button>
        </div>
        <button class="btn btn-outline-primary px-4 fw-bold flex-grow-1" (click)="addToCart()"
          [disabled]="product.stockQuantity === 0">
          <i class="bi bi-cart3 me-2"></i> Thêm vào Giỏ hàng
        </button>
        <button class="btn btn-orange text-white px-5 fw-bold flex-grow-1 shadow-sm" (click)="buyNow()"
          [disabled]="product.stockQuantity === 0">
          Mua Ngay <i class="bi bi-arrow-right ms-2"></i>
        </button>
      </div>

      <div class="d-flex justify-content-between small text-muted border-top border-bottom py-3 mb-4">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-shield-check fs-5 text-primary"></i> Giao dịch bảo mật
        </div>
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-truck fs-5 text-primary"></i> Miễn phí giao hàng
        </div>
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-arrow-counterclockwise fs-5 text-primary"></i> Trả hàng trong 30 ngày
        </div>
      </div>

      <div class="mb-3">
        <h5 class="fw-bold">Mô tả Sản phẩm</h5>
        <div class="mt-3" [innerHTML]="product.description"></div>
      </div>

      <!-- Reviews Section -->
      <div class="mt-5 border-top pt-4">
        <h5 class="fw-bold mb-4">Đánh giá sản phẩm</h5>

        <div class="d-flex align-items-center mb-4 bg-light p-4 rounded-3">
          <div class="text-center me-4">
            <div class="display-4 fw-bold text-warning">{{ averageRating | number:'1.1-1' }}</div>
            <app-star-rating [rating]="averageRating" [readonly]="true" [size]="20"></app-star-rating>
            <div class="text-muted small mt-1">{{ totalReviews }} đánh giá</div>
          </div>
          <!-- Can add progress bars here later if needed -->
        </div>

        <div *ngIf="reviews.length > 0; else noReviews">
          <div *ngFor="let review of reviews" class="border-bottom py-3">
            <div class="d-flex justify-content-between mb-2">
              <div class="d-flex align-items-center gap-2">
                <div class="bg-secondary text-white rounded-circle d-flex justify-content-center align-items-center"
                  style="width: 32px; height: 32px; font-size: 12px;">
                  {{ review.userName?.charAt(0) || 'U' }}
                </div>
                <span class="fw-bold small">{{ review.userName || 'Người dùng ẩn danh' }}</span>
              </div>
              <span class="text-muted small">{{ review.createdAt | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="mb-2">
              <app-star-rating [rating]="review.rating" [readonly]="true" [size]="14"></app-star-rating>
            </div>
            <p class="mb-0 text-secondary">{{ review.comment }}</p>
          </div>
        </div>
        <ng-template #noReviews>
          <div class="text-center text-muted py-4">
            Chưa có đánh giá nào cho sản phẩm này.
          </div>
        </ng-template>

      </div>

    </div>
  </div>
</div>

<div class="lightbox-overlay" *ngIf="isZoomOpen" (click)="closeZoom()">
  <button class="btn-close-lightbox" (click)="closeZoom()">
    <i class="bi bi-x-lg"></i>
  </button>

  <img [src]="mainImage" class="lightbox-img" (click)="$event.stopPropagation()">
</div>