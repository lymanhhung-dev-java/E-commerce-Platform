<form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()" class="checkout-container row g-0">

  <div class="col-lg-7 main-content">

    <div class="mb-4 d-flex align-items-center justify-content-between">
      <h3 class="fw-bold mb-0 text-primary"><i class="bi bi-bag-check-fill"></i> E-Shop</h3>
      <div class="breadcrumb-custom small">
        <a routerLink="/cart">Cart</a>
        <span class="mx-2 text-muted">></span>
        <span class="active">Information & Shipping</span>
      </div>
    </div>

    <h4 class="section-title mt-4">Shipping Address</h4>

    <div class="mb-4" *ngIf="savedAddresses.length > 0">
      <select class="form-select" (change)="onAddressChange($event)">
        <option value="null">-- Chọn địa chỉ có sẵn --</option>
        <option *ngFor="let addr of savedAddresses; let i = index" [value]="i">
          {{ addr.receiverName }} - {{ addr.street }}
        </option>
      </select>
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Tên người nhận</label>
        <input type="text" class="form-control" formControlName="receiverName" placeholder="VD: Nguyễn Văn A">
        <div *ngIf="checkoutForm.get('receiverName')?.invalid && checkoutForm.get('receiverName')?.touched"
          class="text-danger small mt-1">
          Bắt buộc nhập tên
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label">Số điện thoại</label>
        <input type="text" class="form-control" formControlName="phone" placeholder="098...">
      </div>

      <div class="col-12">
        <label class="form-label">Địa chỉ</label>
        <input type="text" class="form-control" formControlName="address" placeholder="Số nhà, tên đường, phường/xã...">
      </div>

      <div class="col-md-6">
        <label class="form-label">Tỉnh / Thành phố</label>
        <input type="text" class="form-control" formControlName="city" placeholder="Hà Nội, TP HCM...">
      </div>

      <div class="col-md-6">
        <label class="form-label">Ghi chú (Tùy chọn)</label>
        <input type="text" class="form-control" formControlName="note" placeholder="VD: Giao giờ hành chính">
      </div>
    </div>

    <h4 class="section-title mt-5">Payment Method</h4>
    <p class="text-muted small mb-3">All transactions are secure and encrypted.</p>

    <div class="payment-box">

      <ng-container *ngFor="let method of paymentMethods">

        <div class="payment-option" [class.selected]="checkoutForm.get('paymentMethod')?.value === method.code">

          <input class="form-check-input mt-0 me-3" type="radio" [value]="method.code" [id]="method.code"
            formControlName="paymentMethod">

          <label class="form-check-label w-100 fw-bold cursor-pointer" [for]="method.code">
            {{ method.name }}
          </label>

          <i class="bi fs-5 text-muted" [ngClass]="method.icon"></i>
        </div>

        <div class="payment-details small text-muted"
          *ngIf="checkoutForm.get('paymentMethod')?.value === method.code && method.description">
          {{ method.description }}
        </div>

      </ng-container>
    </div>

  </div>
  <div class="col-lg-5 sidebar-summary border-start">

    <div class="mb-4">
      <div *ngFor="let item of cartService.cartItems()" class="d-flex align-items-center mb-3">
        <div class="product-thumbnail me-3">
          <img [src]="item.product.imageUrl || 'https://via.placeholder.com/64'" [alt]="item.product.name">
          <span class="qty-badge">{{ item.quantity }}</span>
        </div>

        <div class="flex-grow-1">
          <h6 class="mb-0 text-dark small fw-bold text-truncate" style="max-width: 200px;">
            {{ item.product.name }}
          </h6>
          <small class="text-muted">{{ item.product.shopName }}</small>
        </div>

        <div class="fw-bold small">
          {{ item.product.price * item.quantity | currency:'VND':'symbol':'1.0-0' }}
        </div>
      </div>
    </div>

    <div class="discount-group">
      <input type="text" class="form-control" placeholder="Mã giảm giá">
      <button type="button" class="btn btn-secondary disabled">Áp dụng</button>
    </div>

    <div class="price-row">
      <span>Tạm tính</span>
      <span class="fw-bold">{{ cartService.subTotal() | currency:'VND':'symbol':'1.0-0' }}</span>
    </div>
    <div class="price-row">
      <span>Phí vận chuyển</span>
      <span class="small">Miễn phí</span>
    </div>

    <div class="total-row">
      <span>Tổng cộng</span>
      <div class="d-flex align-items-baseline">
        <span class="usd">VND</span>
        <span class="total-price">{{ cartService.subTotal() | currency:'VND':'symbol':'1.0-0' }}</span>
      </div>
    </div>

    <button type="submit" class="btn-place-order shadow"
      [disabled]="cartService.cartItems().length === 0 || checkoutForm.invalid">
      Đặt Hàng (Place Order)
    </button>

    <div class="text-center mt-3 small text-muted">
      <i class="bi bi-lock-fill"></i> Bảo mật thanh toán bởi E-Shop
    </div>

  </div>
</form>
<div class="row mt-4">
    <div class="col-12">
        <button (click)="onSubmit()" class="btn btn-primary w-100 py-3 fw-bold text-uppercase">
            Xác nhận đặt hàng
        </button>
    </div>
</div>

<div class="modal fade show" tabindex="-1" style="display: block; background: rgba(0,0,0,0.7); z-index: 1055;" *ngIf="showQrModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4 border-0 shadow-lg rounded-4">
      
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="modal-title fw-bold text-primary">Thanh toán chuyển khoản</h5>
        <button type="button" class="btn-close" (click)="closeModal()" [disabled]="isPaymentSuccess"></button>
      </div>

      <div class="modal-body position-relative" style="min-height: 300px;">
        
        <div *ngIf="!isPaymentSuccess && !isExpired" class="animate-fade-in">
            <p class="text-muted mb-3">Mở App Ngân hàng và quét mã bên dưới</p>
            
            <div class="qr-wrapper position-relative d-inline-block p-2 border rounded-3 bg-white shadow-sm mb-3">
                <img [src]="qrCodeUrl" alt="QR Code" class="img-fluid" style="max-width: 220px;">
                <div class="spinner-border text-primary position-absolute top-50 start-50 translate-middle" role="status" style="width: 3rem; height: 3rem; opacity: 0.3; z-index: 0;"></div>
            </div>

            <div>
                <span class="badge bg-danger-subtle text-danger px-3 py-2 rounded-pill border border-danger">
                    Hết hạn sau: <span class="fw-bold fs-5 ms-1">{{ displayTime }}</span>
                </span>
            </div>
            <p class="small text-primary mt-3 fst-italic">
                <i class="bi bi-shield-check"></i> Hệ thống đang tự động kiểm tra giao dịch...
            </p>
        </div>

        <div *ngIf="isPaymentSuccess" class="py-4 text-center success-container">
            <div class="checkmark-wrapper mb-4">
                <div class="checkmark-circle">
                    <div class="background"></div>
                    <div class="checkmark draw"></div>
                </div>
            </div>
            <h3 class="text-success fw-bold mb-2">Thanh toán thành công!</h3>
            <p class="text-muted mb-4">Đang chuyển hướng...</p>
            <div class="progress" style="height: 4px; width: 50%; margin: 0 auto;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 100%"></div>
            </div>
        </div>

        <div *ngIf="isExpired" class="py-5">
            <i class="bi bi-clock-history text-warning" style="font-size: 4rem;"></i>
            <h4 class="text-danger mt-3">Hết thời gian thanh toán</h4>
            <p class="text-muted">Đơn hàng sẽ bị hủy. Vui lòng đặt lại.</p>
            <button class="btn btn-outline-dark mt-2" (click)="closeModal()">Đóng & Đặt lại</button>
        </div>

      </div>
      
      <div class="modal-footer justify-content-center border-0 pt-0" *ngIf="!isPaymentSuccess && !isExpired">
        <button type="button" class="btn btn-link text-decoration-none text-muted" (click)="closeModal()">
            <i class="bi bi-arrow-left"></i> Hủy & Chọn phương thức khác
        </button>
      </div>

    </div>
  </div>
</div>