<div class="container-fluid p-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold mb-1">Quản lý rút tiền</h4>
      <p class="text-muted mb-0">Duyệt và xử lý các yêu cầu thanh toán từ Merchant</p>
    </div>
    
    <select class="form-select w-auto fw-bold" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
      <option value="ALL">Tất cả trạng thái</option>
      <option value="PENDING">Chờ xử lý (Pending)</option>
      <option value="APPROVED">Đã duyệt (Approved)</option>
      <option value="REJECTED">Đã từ chối (Rejected)</option>
    </select>
  </div>

  <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="bg-light">
          <tr>
            <th class="ps-4">Cửa hàng</th>
            <th>Thông tin Ngân hàng</th>
            <th>Số tiền</th>
            <th>Ngày tạo</th>
            <th>Trạng thái</th>
            <th class="text-end pe-4">Thao tác</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of withdrawals">
            <td class="ps-4">
              <div class="fw-bold text-dark">{{ item.shop.name }}</div>
              <small class="text-muted">ID: #{{ item.shop.id }}</small>
            </td>

            <td>
              <div class="fw-bold">{{ item.bankName }}</div>
              <div class="small">{{ item.accountNumber }}</div>
              <div class="small text-muted text-uppercase">{{ item.accountName }}</div>
              <span class="badge bg-light text-secondary border mt-1" *ngIf="item.accountType === 'BUSINESS'">Doanh nghiệp</span>
            </td>

            <td>
              <h6 class="fw-bold text-primary mb-0">{{ item.amount | currency:'VND':'symbol':'1.0-0':'vi-VN' }}</h6>
            </td>

            <td>
              <div class="small">{{ item.createdAt | date:'dd/MM/yyyy' }}</div>
              <div class="small text-muted">{{ item.createdAt | date:'HH:mm' }}</div>
            </td>

            <td>
              <span class="badge rounded-pill px-3 py-2 fw-normal"
                [ngClass]="{
                  'badge-soft-warning': item.status === 'PENDING',
                  'badge-soft-success': item.status === 'APPROVED',
                  'badge-soft-danger': item.status === 'REJECTED'
                }">
                <i class="bi me-1" 
                   [ngClass]="{
                     'bi-hourglass-split': item.status === 'PENDING',
                     'bi-check-circle': item.status === 'APPROVED',
                     'bi-x-circle': item.status === 'REJECTED'
                   }"></i>
                {{ item.status }}
              </span>
              <div *ngIf="item.status === 'REJECTED' && item.rejectReason" class="mt-1 small text-danger">
                Lý do: {{ item.rejectReason }}
              </div>
            </td>

            <td class="text-end pe-4">
              <div *ngIf="item.status === 'PENDING'; else processedBlock">
                <button class="btn btn-sm btn-success me-2" (click)="approve(item.id)" title="Duyệt">
                  <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn btn-sm btn-danger" (click)="openRejectModal(item.id)" title="Từ chối">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
              <ng-template #processedBlock>
                <span class="text-muted small fst-italic">Đã xử lý</span>
              </ng-template>
            </td>
          </tr>

          <tr *ngIf="withdrawals.length === 0 && !isLoading">
            <td colspan="6" class="text-center py-5 text-muted">Không có yêu cầu nào.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card-footer bg-white border-0 py-3 d-flex justify-content-end" *ngIf="totalPages > 0">
        <button class="btn btn-sm btn-light border me-1" [disabled]="currentPage === 0" (click)="onPageChange(currentPage - 1)">Trước</button>
        <span class="btn btn-sm disabled border-0">Trang {{ currentPage + 1 }} / {{ totalPages }}</span>
        <button class="btn btn-sm btn-light border ms-1" [disabled]="currentPage >= totalPages - 1" (click)="onPageChange(currentPage + 1)">Sau</button>
    </div>
  </div>
</div>

<div class="modal fade show" tabindex="-1" *ngIf="showRejectModal" style="display: block;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold text-danger">Từ chối yêu cầu</h5>
        <button type="button" class="btn-close" (click)="showRejectModal = false"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn từ chối yêu cầu này? Tiền sẽ được hoàn lại vào ví của Shop.</p>
        <div class="mb-3">
            <label class="form-label fw-bold">Lý do từ chối <span class="text-danger">*</span></label>
            <textarea class="form-control" rows="3" [(ngModel)]="rejectReason" placeholder="Nhập lý do..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="showRejectModal = false">Hủy</button>
        <button type="button" class="btn btn-danger" (click)="confirmReject()">Xác nhận Từ chối</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showRejectModal"></div>